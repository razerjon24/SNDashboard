{% load staticfiles %}
<title>Mapa de Actividad Online</title>
<link href="{% static 'css/bootstrap.css' %}" rel="stylesheet">
<link href="{% static 'leaflet/leaflet.css' %}" rel="stylesheet">
<link href="{% static 'css/styles.css' %}" rel="stylesheet">
<link href="{% static 'css/bootstrap-slider.css' %}" rel="stylesheet">
<link href="{% static 'font-awesome/css/font-awesome.css' %}" rel="stylesheet">
<link rel="icon" href="{% static 'images/ec.ico' %}">
<script src="{% static 'js/jquery-3.0.0.js' %}"></script>
<script src="{% static 'js/lumino.glyphs.js' %}"></script>
<script src="{% static 'leaflet/leaflet.js' %}"></script>
<script src="{% static 'js/heatmap.js' %}"></script>
<script src="{% static 'js/leaflet-heatmap.js' %}"></script>
<script src="{% static 'js/bootstrap-slider.js' %}"></script>
<script type="text/javascript">
    var mySlider, leftlabel, rightlabel, mySlider2, leftlabel2, rightlabel2, cfg, heatmapLayer, timer, day, hour, dataListAni = [];
    cfg = {
            "radius": 5.5,
            "maxOpacity": 1,
            "minOpacity": 0.23,
            "blur": 0.65,
            "scaleRadius": false,
            "useLocalExtrema": true,
            latField: 'lat',
            lngField: 'lng',
            valueField: 'count'

        };
    heatmapLayer = new HeatmapOverlay(cfg);
    function start_animation(){
        heatmapLayer.setData({data:[]});
        hour = 0;
        day = 17;
        mySlider.disable();
        mySlider2.disable();
        timer = setInterval(function(){
            if(day < 31 && hour < 24){
                $.ajax({url: "test/", async:false ,data:{start_day:day,start_hour:0,end_day:day,end_hour:hour},success: function(result) {
                var lng, lat, count, len;
                for (var i = 0; i < result['len']; i++) {
                    lng = parseFloat(result['lons'][i]);
                    lat = parseFloat(result['lats'][i]);
                    count = parseInt(result['counts'][i]);
                    dataListAni.push({lng: lng, lat: lat, count: count});
                }
                len = result['len'];
                paint_points(dataListAni, len);
                rightlabel.innerHTML = "<strong>"+day+"</strong>";
                rightlabel2.innerHTML = "<strong>"+hour+":00</strong>";
                hour = hour + 1;
                }});
            }
            else if(day < 31 && hour == 24){
                hour = 0;
                day = day + 1;
            }
            else if(day == 31){
                dataListAni = [];
                mySlider.enable();
                mySlider2.enable();
                stop_Timer();
            }
        }, 250);
    }
    function stop_Timer(){
        clearInterval(timer);
    }
    function paint_points(dataList,len){
        var testData = {
        max: len,
        data: dataList
        };
        heatmapLayer.setData(testData);
    }
    window.onload = function() {

        rightlabel = document.getElementById("rightlabel");
        leftlabel = document.getElementById("leftlabel");
        mySlider = new Slider("#slider", {
            id: "slider_dias",
            tooltip: "hide",
            tooltip_position: "bottom",
            range: true,
            value: [17,17],
            min: 17,
            max: 30
        });
        mySlider.on('slideStop', function(event){
            var value = mySlider.getValue();
            heatmapLayer.setData([]);
            leftlabel.innerHTML = "<strong>"+value[0]+"</strong>";
            rightlabel.innerHTML = "<strong>"+value[1]+"</strong>";
            $.ajax({url: "test/", data:{start_day:value[0],start_hour:mySlider2.getValue()[0],end_day:value[1],end_hour:mySlider2.getValue()[1]},success: function(result) {
                var dataList = [], lng, lat, count, len;
                for (var i = 0; i < result['len']; i++) {
                    lng = parseFloat(result['lons'][i]);
                    lat = parseFloat(result['lats'][i]);
                    count = parseInt(result['counts'][i]);
                    dataList.push({lng: lng, lat: lat, count: count});
                }
                len = result['len'];
                paint_points(dataList, len);
            }});

        });
        rightlabel2 = document.getElementById("rightlabel2");
        leftlabel2 = document.getElementById("leftlabel2");
        mySlider2 = new Slider("#slider2", {
            id: "slider_horas",
            tooltip: "hide",
            tooltip_position: "bottom",
            range: true,
            value: [0,0],
            min: 0,
            max: 23
        });
        mySlider2.on('slideStop', function(event) {
            var value = mySlider2.getValue();
            heatmapLayer.setData([]);
            leftlabel2.innerHTML = "<strong>"+value[0]+":00</strong>";
            rightlabel2.innerHTML = "<strong>"+value[1]+":00</strong>";
            $.ajax({url: "test/", data:{start_day:mySlider.getValue()[0],start_hour:value[0],end_day:mySlider.getValue()[1],end_hour:value[1]},success: function(result){
                var dataList = [], lng, lat, count, len;
                for (var i = 0; i < result['len']; i++) {
                    lng = parseFloat(result['lons'][i]);
                    lat = parseFloat(result['lats'][i]);
                    count = parseInt(result['counts'][i]);
                    dataList.push({lng: lng, lat: lat, count: count});
                }
                len = result['len'];
                paint_points(dataList, len);
            }});
        });

        var baseLayer = L.tileLayer(
        'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
                    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
                    maxZoom: 18,
                    minZoom: 7
        }
        );
        var southWest = L.latLng(-5.0159316063, -92.4938964844),
            northEast = L.latLng(1.669685501, -75.1924972534),
            bounds = L.latLngBounds(southWest, northEast);
        var map = new L.Map('map', {
            center: new L.LatLng(-1.601668, -83.672867),
            zoom: 7,
            maxBounds: bounds,
            layers: [baseLayer, heatmapLayer]
        });

        // make accessible for debugging
        layer = heatmapLayer;
        $.ajax({url: "test/", data:{start_day:mySlider.getValue()[0],start_hour:mySlider2.getValue()[0],end_day:mySlider.getValue()[1],end_hour:mySlider2.getValue()[1]},success: function(result){
                var dataList = [], lng, lat, count, len;
                for (var i = 0; i < result['len']; i++) {
                    lng = parseFloat(result['lons'][i]);
                    lat = parseFloat(result['lats'][i]);
                    count = parseInt(result['counts'][i]);
                    dataList.push({lng: lng, lat: lat, count: count});
                }
                len = result['len'];
                paint_points(dataList, len);
            }});
        };
</script>
<body>
	<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#sidebar-collapse">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href=""><span>Terremoto en Ecuador</span> Tablero de Herramientas</a>
			</div>
		</div><!-- /.container-fluid -->
	</nav>

	<div id="sidebar-collapse" class="col-sm-3 col-lg-2 sidebar">
		<ul class="nav menu">
			<li><a href="/" style="font-size: 18px"><svg class="glyph stroked home"><use xlink:href="#stroked-home"/></svg> Home</a></li>
			<li class="parent active">
                <a data-toggle="collapse" href="#sub-item-1" style="font-size: 18px">
                    <svg class="glyph stroked location pin"><use xlink:href="#stroked-location-pin"/></svg> Visualizaci&oacute;n Geogr&aacute;fica
                </a>
				<ul class="children collapse" id="sub-item-1">
					<li>
						<a href="" style="font-size: 18px">
							<svg class="glyph stroked map"><use xlink:href="#stroked-map"/></svg> Actividad Online
						</a>
					</li>
					<li>
						<a href="#" style="font-size: 18px">
							<svg class="glyph stroked landscape"><use xlink:href="#stroked-landscape"/></svg> Geo-Pics
						</a>
					</li>
				</ul>
			</li>
			<li><a href="#" style="font-size: 18px"><svg class="glyph stroked two messages"><use xlink:href="#stroked-two-messages"/></svg> Caracterizaci&oacute;n de T&oacute;picos</a></li>
			<li><a href="#" style="font-size: 18px"><svg class="glyph stroked line-graph"><use xlink:href="#stroked-line-graph"></use></svg> An&aacute;lisis de Sentimientos</a></li>
			<li><a href="#" style="font-size: 18px"><svg class="glyph stroked gear"><use xlink:href="#stroked-gear"/></svg> Grafo de Hashtags</a></li>
		</ul>

	</div><!--/.sidebar-->

	<div class="col-sm-9 col-sm-offset-3 col-lg-10 col-lg-offset-2 main">
		<div class="row">
            <div class="col-lg-12">
                <!-- Modal -->
                <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Modal title</h4>
                      </div>
                      <div class="modal-body">
                        ...
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">Save changes</button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-12" style="margin-top: 2%; margin-bottom: 2%">
                    <div class="col-lg-3">
                        <h2 class="page-header text-center text-primary">Actividad Online</h2>
                    </div>
                    <div class="col-lg-6">
                        <p class="text-center" style="font-size: 18px">Seleccione los d&iacute;as a observar</p>
                        <div class="col-md-12">
                            <div class="col-md-1">
                                <p id="leftlabel" class="text-right"><strong>17</strong></p>
                            </div>
                            <div class="col-md-10">
                                <input style="width: 100%" id="slider">
                            </div>
                            <div class="col-md-1">
                                <p id="rightlabel" class="text-left"><strong>17</strong></p>
                            </div>
                        </div>
                        <p class="text-center" style="font-size: 18px">Seleccione las horas a observar</p>
                        <div class="col-md-12" style="margin-bottom: 1%">
                            <div class="col-md-1">
                                <p id="leftlabel2" class="text-right"><strong>0:00</strong></p>
                            </div>
                            <div class="col-md-10">
                                <input style="width: 100%" id="slider2">
                            </div>
                            <div class="col-md-1">
                                <p id="rightlabel2" class="text-left"><strong>0:00</strong></p>
                            </div>
                        </div>
                    </div><!--/.col-->
                    <div class="col-lg-3 text-center">
                        <button id="test" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#myModal"><i class="fa fa-play fa-5x" style="padding: 8px 18px" onclick="start_animation()"><p style="font-size: 18px; color: white; margin-top: 20%">Animar</p></i></button>
                    </div>
                </div>
                <div class="col-md-12" id="map" style="height: 700px"></div>
            </div>
		</div><!--/.row-->


	</div>	<!--/.main-->
	<script src="{% static 'js/bootstrap.js' %}"></script>
</body>